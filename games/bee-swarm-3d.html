<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee Swarm 3D - Game Hub</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #000; font-family: 'Inter', Arial, sans-serif; }

        #c { display: block; width: 100vw; height: 100vh; touch-action: none; cursor: grab; }
        #c.dragging { cursor: grabbing; }

        .hud {
            position: fixed; top: 0; left: 0;
            padding: 12px 16px; pointer-events: none; z-index: 10;
        }

        .hud-box {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,200,0,0.35);
            border-radius: 12px;
            padding: 10px 16px;
            color: #fff;
            pointer-events: auto;
            backdrop-filter: blur(6px);
            font-size: 13px;
            line-height: 1.7;
        }

        .hud-box .val { color: #ffc107; font-weight: 700; }
        .hud-box .g { color: #00ff88; font-weight: 700; }

        .back-link {
            position: fixed; top: 12px; right: 16px; z-index: 20;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: #fff;
            padding: 7px 14px; text-decoration: none; font-size: 13px;
        }
        .back-link:hover { background: rgba(0,0,0,0.8); }
        .fullscreen-btn { position: fixed; top: 12px; right: 160px; z-index: 20; }

        /* ── Tool Bar ── */
        .toolbar {
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 5px; z-index: 16;
        }
        .tool-slot {
            width: 52px; height: 52px;
            background: rgba(0,0,0,0.6);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
            position: relative; font-size: 22px;
            backdrop-filter: blur(6px);
        }
        .tool-slot .tool-key {
            position: absolute; top: 2px; right: 4px;
            font-size: 9px; color: rgba(255,255,255,0.4);
        }
        .tool-slot.active { border-color: #ffc107; background: rgba(255,200,0,0.15); box-shadow: 0 0 10px rgba(255,200,0,0.3); }
        .tool-slot.locked { opacity: 0.3; cursor: not-allowed; }
        .tool-slot:hover:not(.locked) { border-color: rgba(255,200,0,0.6); }

        /* ── Shop ── */
        .shop {
            position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 6px; z-index: 15;
        }
        .shop button {
            background: rgba(0,0,0,0.65);
            border: 1px solid rgba(255,200,0,0.4);
            border-radius: 10px; color: #fff;
            padding: 7px 12px; cursor: pointer;
            font-size: 11px; font-family: inherit;
            backdrop-filter: blur(6px); transition: all 0.2s; line-height: 1.3;
        }
        .shop button:hover { background: rgba(255,200,0,0.15); border-color: #ffc107; }
        .shop button:disabled { opacity: 0.35; cursor: not-allowed; }
        .shop .cost { color: #ffc107; font-weight: 700; }

        /* ── Quest Panel ── */
        .quest-panel {
            position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
            z-index: 12; pointer-events: auto;
        }
        .quest-toggle {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(0,217,255,0.4);
            border-radius: 8px; color: #fff; padding: 6px 16px;
            cursor: pointer; font-size: 12px; font-family: inherit;
            backdrop-filter: blur(6px);
        }
        .quest-toggle .qcount { color: #00d9ff; font-weight: 700; }
        .quest-list {
            display: none; margin-top: 6px;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(0,217,255,0.3);
            border-radius: 12px; padding: 12px 16px;
            max-width: 340px; width: 340px;
            max-height: 320px; overflow-y: auto;
            backdrop-filter: blur(8px);
        }
        .quest-list.open { display: block; }
        .quest-item {
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.08);
            font-size: 12px; line-height: 1.5;
        }
        .quest-item:last-child { border-bottom: none; }
        .quest-item .q-title { color: #00d9ff; font-weight: 600; font-size: 13px; }
        .quest-item .q-from { color: #888; font-size: 10px; }
        .quest-item .q-desc { color: #ccc; margin: 3px 0; }
        .quest-item .q-prog {
            background: rgba(255,255,255,0.1); border-radius: 4px;
            height: 6px; margin-top: 4px; overflow: hidden;
        }
        .quest-item .q-prog-fill {
            height: 100%; border-radius: 4px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            transition: width 0.3s;
        }
        .quest-item .q-reward { color: #ffc107; font-size: 11px; margin-top: 3px; }
        .quest-item.completed .q-title { color: #00ff88; }
        .quest-item.completed .q-title::after { content: ' ✓'; }

        /* ── NPC Dialog ── */
        .npc-dialog {
            position: fixed; bottom: 130px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.88); border: 2px solid #00d9ff;
            border-radius: 16px; padding: 18px 24px;
            color: #fff; z-index: 50; display: none;
            max-width: 400px; width: 90%;
            backdrop-filter: blur(10px); text-align: center;
        }
        .npc-dialog .npc-name { color: #ffc107; font-weight: 700; font-size: 16px; margin-bottom: 6px; }
        .npc-dialog .npc-text { font-size: 14px; line-height: 1.5; margin-bottom: 12px; }
        .npc-dialog .npc-btns { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .npc-dialog .npc-btn {
            padding: 7px 18px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.08); color: #fff;
            cursor: pointer; font-size: 13px; font-family: inherit; transition: all 0.2s;
        }
        .npc-dialog .npc-btn:hover { background: rgba(0,217,255,0.2); border-color: #00d9ff; }
        .npc-dialog .npc-btn.primary { background: #ffc107; color: #000; border-color: #ffc107; font-weight: 700; }

        /* ── Power-up Indicators ── */
        .powerup-bar {
            position: fixed; top: 12px; right: 180px;
            display: flex; gap: 6px; z-index: 12;
        }
        .pu-active {
            background: rgba(0,0,0,0.6);
            border: 1px solid; border-radius: 8px;
            padding: 5px 10px; font-size: 11px; color: #fff;
            backdrop-filter: blur(6px); white-space: nowrap;
        }
        .pu-active .pu-time { font-weight: 700; }

        /* ── Interact Prompt ── */
        .interact-prompt {
            position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); border: 1px solid rgba(0,217,255,0.5);
            border-radius: 8px; padding: 6px 16px; color: #fff;
            font-size: 13px; z-index: 14; display: none;
            backdrop-filter: blur(6px);
        }

        /* ── D-pad ── */
        .dpad {
            position: fixed; bottom: 90px; left: 20px; z-index: 15;
            display: none;
            grid-template-columns: 56px 56px 56px;
            grid-template-rows: 56px 56px;
            gap: 4px;
        }
        @media (pointer: coarse) { .dpad { display: grid; } }
        .dpad button {
            width: 56px; height: 56px;
            background: rgba(0,0,0,0.45);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 12px; color: #fff; font-size: 22px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none; -webkit-user-select: none; touch-action: none;
        }
        .dpad button:active { background: rgba(255,200,0,0.25); }
        .dpad .u { grid-column: 2; grid-row: 1; }
        .dpad .l { grid-column: 1; grid-row: 2; }
        .dpad .d { grid-column: 2; grid-row: 2; }
        .dpad .r { grid-column: 3; grid-row: 2; }

        .hint {
            position: fixed; bottom: 120px; right: 16px; z-index: 15;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px; padding: 8px 12px;
            color: rgba(255,255,255,0.6); font-size: 11px; line-height: 1.6;
            transition: opacity 0.8s;
        }

        .minimap {
            position: fixed; bottom: 16px; right: 16px;
            width: 140px; height: 140px;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,200,0,0.3);
            border-radius: 10px; z-index: 15; overflow: hidden;
        }
        .minimap canvas { width: 100%; height: 100%; }

        .popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
            background: rgba(0,0,0,0.88); border: 2px solid #ffc107;
            border-radius: 16px; padding: 28px 36px; color: #fff;
            z-index: 100; text-align: center;
            backdrop-filter: blur(10px); display: none; max-width: 380px;
        }
        .popup h2 { color: #ffc107; margin: 0 0 8px; }
        .popup p { margin: 0 0 18px; font-size: 15px; line-height: 1.5; }
        .popup button {
            background: #ffc107; color: #000; border: none;
            padding: 9px 28px; border-radius: 8px;
            font-size: 15px; font-weight: 700; cursor: pointer;
        }
    </style>
</head>
<body>
    <button class="fullscreen-btn" id="fullscreenBtn">&#x26F6;</button>
    <a href="../index.html" class="back-link">&#8592; Back to Games</a>

    <canvas id="c"></canvas>

    <!-- HUD -->
    <div class="hud">
        <div class="hud-box">
            &#127855; Honey: <span class="val" id="hHoney">0</span><br>
            &#127804; Pollen: <span class="val" id="hPollen">0</span>
            <span style="color:#777">/ <span id="hPolMax">100</span></span><br>
            &#128029; Bees: <span class="val" id="hBees">3</span>
            &#11088; Lv: <span class="g" id="hLvl">1</span>
        </div>
    </div>

    <!-- Quest Panel -->
    <div class="quest-panel">
        <button class="quest-toggle" id="questToggle" onclick="toggleQuests()">&#128220; Quests <span class="qcount" id="qCount">0/0</span></button>
        <div class="quest-list" id="questList"></div>
    </div>

    <!-- Power-up Indicators -->
    <div class="powerup-bar" id="puBar"></div>

    <!-- Tool Bar -->
    <div class="toolbar" id="toolbar"></div>

    <!-- Shop -->
    <div class="shop" id="shopBar">
        <button id="sBee" onclick="buyBee()">&#128029; Bee<br><span class="cost" id="cBee">50</span></button>
        <button id="sBag" onclick="upgBag()">&#127890; Bag+<br><span class="cost" id="cBag">100</span></button>
        <button id="sSpd" onclick="upgSpd()">&#9889; Spd+<br><span class="cost" id="cSpd">75</span></button>
        <button id="sFld" onclick="unlockFld()">&#127793; Field<br><span class="cost" id="cFld">500</span></button>
    </div>

    <!-- D-pad -->
    <div class="dpad" id="dpad">
        <button class="u" data-d="u">&#9650;</button>
        <button class="l" data-d="l">&#9664;</button>
        <button class="d" data-d="d">&#9660;</button>
        <button class="r" data-d="r">&#9654;</button>
    </div>

    <!-- Interact Prompt -->
    <div class="interact-prompt" id="interactPrompt">Press <b>E</b> to talk</div>

    <!-- NPC Dialog -->
    <div class="npc-dialog" id="npcDialog">
        <div class="npc-name" id="npcName"></div>
        <div class="npc-text" id="npcText"></div>
        <div class="npc-btns" id="npcBtns"></div>
    </div>

    <div class="hint" id="hint">
        WASD: Move | Mouse drag: Orbit<br>
        Scroll: Zoom | E: Interact<br>
        1-5: Tools | Walk to hive for honey
    </div>

    <div class="minimap"><canvas id="mm" width="140" height="140"></canvas></div>

    <div class="popup" id="pop">
        <h2 id="popT"></h2>
        <p id="popB"></p>
        <button onclick="document.getElementById('pop').style.display='none'">OK</button>
    </div>

    <script>
    /* ================================================================
       BEE SWARM 3D  –  Pure WebGL, zero dependencies
       Camera + Tools + Quests + NPCs + Power-ups
       ================================================================ */
    const cv = document.getElementById('c');
    const gl = cv.getContext('webgl') || cv.getContext('experimental-webgl');

    /* ── math ──────────────────────────────────────────────────────── */
    const m4 = {
        cr: () => new Float32Array(16),
        id: o => { o.fill(0); o[0]=o[5]=o[10]=o[15]=1; return o; },
        persp(o,fov,a,n,f){const t=1/Math.tan(fov/2);o.fill(0);o[0]=t/a;o[5]=t;o[10]=(f+n)/(n-f);o[11]=-1;o[14]=2*f*n/(n-f);return o;},
        tr(o,m,v){for(let i=0;i<16;i++)o[i]=m[i];o[12]+=m[0]*v[0]+m[4]*v[1]+m[8]*v[2];o[13]+=m[1]*v[0]+m[5]*v[1]+m[9]*v[2];o[14]+=m[2]*v[0]+m[6]*v[1]+m[10]*v[2];return o;},
        sc(o,m,v){for(let i=0;i<4;i++){o[i]=m[i]*v[0];o[4+i]=m[4+i]*v[1];o[8+i]=m[8+i]*v[2];o[12+i]=m[12+i];}return o;},
        rY(o,m,r){const c=Math.cos(r),s=Math.sin(r);for(let i=0;i<16;i++)o[i]=m[i];for(let i=0;i<4;i++){const a=m[i],b=m[8+i];o[i]=a*c+b*s;o[8+i]=b*c-a*s;}return o;},
        mul(o,a,b){for(let i=0;i<4;i++)for(let j=0;j<4;j++){let s=0;for(let k=0;k<4;k++)s+=a[4*k+i]*b[4*j+k];o[4*j+i]=s;}return o;},
        lookAt(o,e,c,u){let zx=e[0]-c[0],zy=e[1]-c[1],zz=e[2]-c[2],l=1/Math.sqrt(zx*zx+zy*zy+zz*zz);zx*=l;zy*=l;zz*=l;let xx=u[1]*zz-u[2]*zy,xy=u[2]*zx-u[0]*zz,xz=u[0]*zy-u[1]*zx;l=Math.sqrt(xx*xx+xy*xy+xz*xz);if(l){l=1/l;xx*=l;xy*=l;xz*=l;}let yx=zy*xz-zz*xy,yy=zz*xx-zx*xz,yz=zx*xy-zy*xx;o[0]=xx;o[1]=yx;o[2]=zx;o[3]=0;o[4]=xy;o[5]=yy;o[6]=zy;o[7]=0;o[8]=xz;o[9]=yz;o[10]=zz;o[11]=0;o[12]=-(xx*e[0]+xy*e[1]+xz*e[2]);o[13]=-(yx*e[0]+yy*e[1]+yz*e[2]);o[14]=-(zx*e[0]+zy*e[1]+zz*e[2]);o[15]=1;return o;}
    };

    /* ── shaders ───────────────────────────────────────────────────── */
    const VS=`attribute vec3 aP,aN;uniform mat4 uMVP,uM;varying vec3 vN,vW;
    void main(){gl_Position=uMVP*vec4(aP,1.);vN=mat3(uM)*aN;vW=(uM*vec4(aP,1.)).xyz;}`;
    const FS=`precision mediump float;varying vec3 vN,vW;uniform vec3 uC,uL;uniform float uA;
    void main(){vec3 n=normalize(vN);float d=max(dot(n,normalize(uL)),0.);vec3 c=uC*(uA+d*(1.-uA));
    float fog=clamp(length(vW)*0.005,0.,1.);c=mix(c,vec3(.47,.76,.96),fog*.4);gl_FragColor=vec4(c,1.);}`;

    function mkSh(t,s){const sh=gl.createShader(t);gl.shaderSource(sh,s);gl.compileShader(sh);return sh;}
    function mkPr(v,f){const p=gl.createProgram();gl.attachShader(p,mkSh(gl.VERTEX_SHADER,v));gl.attachShader(p,mkSh(gl.FRAGMENT_SHADER,f));gl.linkProgram(p);return p;}
    const pr=mkPr(VS,FS);
    const ul={aP:gl.getAttribLocation(pr,'aP'),aN:gl.getAttribLocation(pr,'aN'),
        uMVP:gl.getUniformLocation(pr,'uMVP'),uM:gl.getUniformLocation(pr,'uM'),
        uC:gl.getUniformLocation(pr,'uC'),uL:gl.getUniformLocation(pr,'uL'),uA:gl.getUniformLocation(pr,'uA')};

    /* ── geometry ──────────────────────────────────────────────────── */
    function mkBuf(pos,nrm,idx){
        const m={};
        m.pb=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,m.pb);gl.bufferData(gl.ARRAY_BUFFER,pos,gl.STATIC_DRAW);
        m.nb=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,m.nb);gl.bufferData(gl.ARRAY_BUFFER,nrm,gl.STATIC_DRAW);
        m.ib=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,m.ib);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,idx,gl.STATIC_DRAW);
        m.cnt=idx.length; return m;
    }
    function mkBox(){
        const p=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1];
        const n=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0];
        const idx=[];for(let i=0;i<6;i++){const o=i*4;idx.push(o,o+1,o+2,o,o+2,o+3);}
        return mkBuf(new Float32Array(p),new Float32Array(n),new Uint16Array(idx));
    }
    function mkSph(sg=12){
        const p=[],n=[],idx=[];
        for(let y=0;y<=sg;y++)for(let x=0;x<=sg;x++){const u=x/sg,v=y/sg,th=u*Math.PI*2,ph=v*Math.PI;const nx=Math.sin(ph)*Math.cos(th),ny=Math.cos(ph),nz=Math.sin(ph)*Math.sin(th);p.push(nx,ny,nz);n.push(nx,ny,nz);}
        for(let y=0;y<sg;y++)for(let x=0;x<sg;x++){const a=y*(sg+1)+x,b=a+sg+1;idx.push(a,b,a+1,b,b+1,a+1);}
        return mkBuf(new Float32Array(p),new Float32Array(n),new Uint16Array(idx));
    }
    function mkCyl(sg=10){
        const p=[],n=[],idx=[];
        for(let i=0;i<=sg;i++){const a=i/sg*Math.PI*2,c=Math.cos(a),s=Math.sin(a);p.push(c,-1,s,c,1,s);n.push(c,0,s,c,0,s);}
        for(let i=0;i<sg;i++){const a=i*2,b=a+2;idx.push(a,b,a+1,b,b+1,a+1);}
        const tb=p.length/3;p.push(0,1,0);n.push(0,1,0);
        for(let i=0;i<=sg;i++){const a=i/sg*Math.PI*2;p.push(Math.cos(a),1,Math.sin(a));n.push(0,1,0);}
        for(let i=0;i<sg;i++)idx.push(tb,tb+1+i,tb+2+i);
        const bb=p.length/3;p.push(0,-1,0);n.push(0,-1,0);
        for(let i=0;i<=sg;i++){const a=i/sg*Math.PI*2;p.push(Math.cos(a),-1,Math.sin(a));n.push(0,-1,0);}
        for(let i=0;i<sg;i++)idx.push(bb,bb+2+i,bb+1+i);
        return mkBuf(new Float32Array(p),new Float32Array(n),new Uint16Array(idx));
    }
    function mkCone(sg=10){
        const p=[],n=[],idx=[];
        p.push(0,1,0);n.push(0,1,0);
        for(let i=0;i<=sg;i++){const a=i/sg*Math.PI*2,c=Math.cos(a),s=Math.sin(a);p.push(c,-1,s);const nl=.707;n.push(c*nl,nl,s*nl);}
        for(let i=0;i<sg;i++)idx.push(0,1+i,2+i);
        const bb=p.length/3;p.push(0,-1,0);n.push(0,-1,0);
        for(let i=0;i<=sg;i++){const a=i/sg*Math.PI*2;p.push(Math.cos(a),-1,Math.sin(a));n.push(0,-1,0);}
        for(let i=0;i<sg;i++)idx.push(bb,bb+2+i,bb+1+i);
        return mkBuf(new Float32Array(p),new Float32Array(n),new Uint16Array(idx));
    }
    const gBox=mkBox(),gSph=mkSph(14),gCyl=mkCyl(10),gCone=mkCone(10);

    /* ── draw helpers ──────────────────────────────────────────────── */
    const vp=m4.cr(),tm=m4.cr(),pr_=m4.cr(),vw=m4.cr();
    function draw(mesh,model,col){
        const mvp=m4.cr();m4.mul(mvp,vp,model);
        gl.uniformMatrix4fv(ul.uMVP,false,mvp);gl.uniformMatrix4fv(ul.uM,false,model);gl.uniform3fv(ul.uC,col);
        gl.bindBuffer(gl.ARRAY_BUFFER,mesh.pb);gl.vertexAttribPointer(ul.aP,3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(ul.aP);
        gl.bindBuffer(gl.ARRAY_BUFFER,mesh.nb);gl.vertexAttribPointer(ul.aN,3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(ul.aN);
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,mesh.ib);gl.drawElements(gl.TRIANGLES,mesh.cnt,gl.UNSIGNED_SHORT,0);
    }
    function mat(pos,scl){const o=m4.cr();m4.id(o);m4.tr(tm,o,pos);m4.sc(o,tm,scl);return o;}

    /* ═══════════════════════════════════════════════════════════════════
       GAME STATE
       ═════════════════════════════════════════════════════════════════ */
    let honey=0, pollen=0, polMax=100, nBees=3, lvl=1, pSpeed=0.14;
    let pX=0, pZ=0;
    let beePrc=50, bagPrc=100, spdPrc=75, fldPrc=500, totHoney=0, totPollen=0;
    let frame=0;

    // ── Camera state ──
    let camAngle=0, camPitch=0.55, camDist=20;
    let camDragging=false, camLastX=0, camLastY=0;

    // ── Tool state ──
    let activeTool=0;
    let toolsUnlocked=[true,false,false,false,false];

    // ── Quest state ──
    let questsDone=[];
    let questsOpen=false;

    // ── Power-up state ──
    let activePowerups=[];
    let puSpawns=[];
    let puSpawnTimer=0;

    // Load save
    try{
        const s=JSON.parse(localStorage.getItem('bs3dSave2'));
        if(s){
            honey=s.h||0;nBees=s.b||3;polMax=s.pm||100;pSpeed=s.ps||.14;lvl=s.l||1;
            beePrc=s.bp||50;bagPrc=s.bg||100;spdPrc=s.sp||75;fldPrc=s.fp||500;
            totHoney=s.th||0;totPollen=s.tp||0;
            if(s.tu)toolsUnlocked=s.tu;
            if(s.qd)questsDone=s.qd;
        }
    }catch(e){}

    /* ═══════════════════════════════════════════════════════════════════
       1. CAMERA CONTROLS
       ═════════════════════════════════════════════════════════════════ */
    cv.addEventListener('mousedown',e=>{
        if(e.button===0||e.button===2){camDragging=true;camLastX=e.clientX;camLastY=e.clientY;cv.classList.add('dragging');}
    });
    window.addEventListener('mousemove',e=>{
        if(!camDragging)return;
        const dx=e.clientX-camLastX, dy=e.clientY-camLastY;
        camAngle-=dx*0.005;
        camPitch=Math.max(0.15,Math.min(1.3,camPitch+dy*0.005));
        camLastX=e.clientX;camLastY=e.clientY;
    });
    window.addEventListener('mouseup',()=>{camDragging=false;cv.classList.remove('dragging');});
    cv.addEventListener('wheel',e=>{
        e.preventDefault();
        camDist=Math.max(8,Math.min(40,camDist+e.deltaY*0.02));
    },{passive:false});
    cv.addEventListener('contextmenu',e=>e.preventDefault());

    // Touch orbit + pinch zoom
    let touchIds=[], touchDist0=0;
    cv.addEventListener('touchstart',e=>{
        if(e.touches.length===1){camDragging=true;camLastX=e.touches[0].clientX;camLastY=e.touches[0].clientY;}
        if(e.touches.length===2){
            const dx=e.touches[0].clientX-e.touches[1].clientX;
            const dy=e.touches[0].clientY-e.touches[1].clientY;
            touchDist0=Math.sqrt(dx*dx+dy*dy);
        }
    },{passive:true});
    cv.addEventListener('touchmove',e=>{
        if(e.touches.length===1&&camDragging){
            const dx=e.touches[0].clientX-camLastX, dy=e.touches[0].clientY-camLastY;
            camAngle-=dx*0.005; camPitch=Math.max(0.15,Math.min(1.3,camPitch+dy*0.005));
            camLastX=e.touches[0].clientX;camLastY=e.touches[0].clientY;
        }
        if(e.touches.length===2){
            const dx=e.touches[0].clientX-e.touches[1].clientX;
            const dy=e.touches[0].clientY-e.touches[1].clientY;
            const d=Math.sqrt(dx*dx+dy*dy);
            if(touchDist0>0){camDist=Math.max(8,Math.min(40,camDist-(d-touchDist0)*0.05));}
            touchDist0=d;
        }
    },{passive:true});
    cv.addEventListener('touchend',()=>{camDragging=false;touchDist0=0;});

    /* ═══════════════════════════════════════════════════════════════════
       2. TOOLS SYSTEM
       ═════════════════════════════════════════════════════════════════ */
    const TOOLS=[
        {id:'net',       name:'Pollen Net',     icon:'\uD83E\uDD4F', desc:'Basic collector',                        cost:0,     effect:'base'},
        {id:'smoker',    name:'Bee Smoker',      icon:'\uD83D\uDCA8', desc:'Bees gather 2x faster',                  cost:200,   effect:'beeSpeed'},
        {id:'rake',      name:'Golden Rake',     icon:'\uD83E\uDEAE', desc:'Flowers give 2x pollen',                 cost:500,   effect:'pollenMult'},
        {id:'jar',       name:'Royal Jelly Jar', icon:'\uD83C\uDFFA', desc:'Honey conversion 3x rate',               cost:1000,  effect:'convertRate'},
        {id:'scepter',   name:'Honey Scepter',   icon:'\uD83D\uDD31', desc:'All bonuses at 1.5x',                    cost:5000,  effect:'allBoost'}
    ];

    function renderToolbar(){
        let h='';
        TOOLS.forEach((t,i)=>{
            const locked=!toolsUnlocked[i];
            h+=`<div class="tool-slot${i===activeTool?' active':''}${locked?' locked':''}" onclick="selectTool(${i})" title="${t.name}: ${t.desc}">
                <span class="tool-key">${i+1}</span>${locked?'\uD83D\uDD12':t.icon}</div>`;
        });
        document.getElementById('toolbar').innerHTML=h;
    }

    window.selectTool=function(i){
        if(!toolsUnlocked[i])return;
        activeTool=i;
        renderToolbar();
    };

    function getToolMult(type){
        const t=TOOLS[activeTool];
        if(t.effect==='beeSpeed'&&type==='beeSpeed')return 2;
        if(t.effect==='pollenMult'&&type==='pollenMult')return 2;
        if(t.effect==='convertRate'&&type==='convertRate')return 3;
        if(t.effect==='allBoost')return 1.5;
        return 1;
    }

    /* ═══════════════════════════════════════════════════════════════════
       3. QUEST SYSTEM
       ═════════════════════════════════════════════════════════════════ */
    const QUESTS=[
        {id:'q1', from:'Bee Bear',     title:'First Steps',       desc:'Collect 100 pollen total',            type:'pollen',   target:100,    reward:{honey:100},       rewardText:'+100 honey'},
        {id:'q2', from:'Bee Bear',     title:'Honey Maker',       desc:'Earn 200 honey total',                type:'honey',    target:200,    reward:{honey:200},       rewardText:'+200 honey'},
        {id:'q3', from:'Mother Bear',  title:'Growing Swarm',     desc:'Have 5 bees in your swarm',           type:'bees',     target:5,      reward:{honey:300},       rewardText:'+300 honey'},
        {id:'q4', from:'Mother Bear',  title:'Explorer',          desc:'Reach level 3',                       type:'level',    target:3,      reward:{tool:1},          rewardText:'Unlock Bee Smoker'},
        {id:'q5', from:'Science Bear', title:'Field Research',    desc:'Collect 1,000 pollen total',          type:'pollen',   target:1000,   reward:{tool:2},          rewardText:'Unlock Golden Rake'},
        {id:'q6', from:'Science Bear', title:'Sweet Science',     desc:'Earn 2,000 honey total',              type:'honey',    target:2000,   reward:{honey:1000},      rewardText:'+1,000 honey'},
        {id:'q7', from:'Polar Bear',   title:'Big Swarm',         desc:'Have 10 bees in your swarm',          type:'bees',     target:10,     reward:{tool:3},          rewardText:'Unlock Royal Jelly Jar'},
        {id:'q8', from:'Polar Bear',   title:'Pollen Master',     desc:'Collect 10,000 pollen total',         type:'pollen',   target:10000,  reward:{honey:5000},      rewardText:'+5,000 honey'},
        {id:'q9', from:'Bee Bear',     title:'Honey Tycoon',      desc:'Earn 20,000 honey total',             type:'honey',    target:20000,  reward:{tool:4},          rewardText:'Unlock Honey Scepter'},
        {id:'q10',from:'Science Bear', title:'Legend',             desc:'Reach level 10',                      type:'level',    target:10,     reward:{honey:50000},     rewardText:'+50,000 honey'},
        {id:'q11',from:'Mother Bear',  title:'Mega Swarm',        desc:'Have 20 bees in your swarm',          type:'bees',     target:20,     reward:{honey:10000},     rewardText:'+10,000 honey'},
        {id:'q12',from:'Polar Bear',   title:'Pollen Legend',     desc:'Collect 100,000 pollen total',        type:'pollen',   target:100000, reward:{honey:25000},     rewardText:'+25,000 honey'},
    ];

    function getQuestProgress(q){
        if(q.type==='pollen')return Math.min(totPollen,q.target);
        if(q.type==='honey')return Math.min(totHoney,q.target);
        if(q.type==='bees')return Math.min(nBees,q.target);
        if(q.type==='level')return Math.min(lvl,q.target);
        return 0;
    }

    function checkQuests(){
        QUESTS.forEach(q=>{
            if(questsDone.includes(q.id))return;
            if(getQuestProgress(q)>=q.target){
                questsDone.push(q.id);
                // Give reward
                if(q.reward.honey) honey+=q.reward.honey;
                if(q.reward.tool!==undefined){toolsUnlocked[q.reward.tool]=true;renderToolbar();}
                msg('Quest Complete!',q.title+' — '+q.rewardText);
                save();
            }
        });
    }

    function renderQuests(){
        const el=document.getElementById('questList');
        const active=QUESTS.filter(q=>!questsDone.includes(q.id));
        const done=QUESTS.filter(q=>questsDone.includes(q.id));
        document.getElementById('qCount').textContent=done.length+'/'+QUESTS.length;
        let h='';
        active.forEach(q=>{
            const prog=getQuestProgress(q);
            const pct=Math.min(100,prog/q.target*100);
            h+=`<div class="quest-item">
                <div class="q-title">${q.title}</div><div class="q-from">${q.from}</div>
                <div class="q-desc">${q.desc}</div>
                <div class="q-prog"><div class="q-prog-fill" style="width:${pct}%"></div></div>
                <div class="q-reward">Reward: ${q.rewardText} (${Math.floor(prog)}/${q.target})</div>
            </div>`;
        });
        done.slice().reverse().forEach(q=>{
            h+=`<div class="quest-item completed">
                <div class="q-title">${q.title}</div><div class="q-from">${q.from}</div>
                <div class="q-desc">${q.desc}</div>
                <div class="q-reward">Reward: ${q.rewardText}</div>
            </div>`;
        });
        if(!h)h='<div style="color:#888;text-align:center;padding:10px">All quests completed!</div>';
        el.innerHTML=h;
    }

    window.toggleQuests=function(){
        questsOpen=!questsOpen;
        document.getElementById('questList').classList.toggle('open',questsOpen);
        if(questsOpen)renderQuests();
    };

    /* ═══════════════════════════════════════════════════════════════════
       4. NPC SYSTEM
       ═════════════════════════════════════════════════════════════════ */
    const NPCS=[
        {id:'beeBear',    name:'Bee Bear',     icon:'\uD83D\uDC3B', color:[.6,.35,.15],
         x:5, z:12, dialogs:[
            {text:"Hey there, beekeeper! I'm Bee Bear. I love honey more than anything! Complete my quests to earn rewards.", options:['Show Quests','Bye']},
            {text:"Your bees are doing great! Keep collecting pollen and converting it at the hive.", options:['Thanks','Bye']},
            {text:"Did you know? The more bees you have, the faster you collect pollen!", options:['Cool!','Bye']}
        ]},
        {id:'motherBear', name:'Mother Bear',  icon:'\uD83D\uDC3B', color:[.7,.5,.3],
         x:-12, z:-25, dialogs:[
            {text:"Welcome, dear! I'm Mother Bear. I watch over the Sunflower Field. Grow your swarm and I'll reward you!", options:['Show Quests','Bye']},
            {text:"Have you tried different tools? Each one helps in a different way. The Smoker makes bees move faster!", options:['Good to know!','Bye']},
            {text:"Power-ups appear around the fields sometimes. Walk over them to pick them up!", options:['I\'ll look!','Bye']}
        ]},
        {id:'scienceBear',name:'Science Bear',  icon:'\uD83D\uDC3B', color:[.5,.5,.6],
         x:-38, z:-25, dialogs:[
            {text:"Fascinating! I'm Science Bear. My research shows that tool selection greatly affects efficiency. Complete quests to unlock new tools!", options:['Show Quests','Buy Tools','Bye']},
            {text:"My data indicates that the Golden Rake doubles pollen from flowers. Very efficient for field work!", options:['Interesting!','Bye']},
            {text:"The Royal Jelly Jar triples your honey conversion rate. Optimal for maximizing output!", options:['Thanks!','Bye']}
        ]},
        {id:'polarBear',  name:'Polar Bear',   icon:'\uD83D\uDC3B', color:[.85,.85,.9],
         x:5, z:-60, dialogs:[
            {text:"Brrr! I'm Polar Bear. I like challenges! My quests are tough but the rewards are worth it.", options:['Show Quests','Bye']},
            {text:"I've hidden some power-ups around the fields. The Honey Storm is my favorite - it rains honey!", options:['Awesome!','Bye']},
            {text:"Keep pushing for more bees and higher levels. The Honey Scepter is the ultimate tool!", options:['I want it!','Bye']}
        ]}
    ];

    let nearNpc=null, npcDialogOpen=false, currentNpcIdx=0;

    function checkNpcProximity(){
        nearNpc=null;
        for(const npc of NPCS){
            const d=Math.sqrt((pX-npc.x)**2+(pZ-npc.z)**2);
            if(d<4){nearNpc=npc;break;}
        }
        document.getElementById('interactPrompt').style.display=nearNpc&&!npcDialogOpen?'block':'none';
    }

    function openNpcDialog(npc){
        if(!npc)return;
        npcDialogOpen=true;
        currentNpcIdx=Math.floor(Math.random()*npc.dialogs.length);
        const dlg=npc.dialogs[currentNpcIdx];
        document.getElementById('npcName').textContent=npc.icon+' '+npc.name;
        document.getElementById('npcText').textContent=dlg.text;
        let btns='';
        dlg.options.forEach(opt=>{
            if(opt==='Show Quests')btns+=`<button class="npc-btn primary" onclick="npcAction('quests')">Show Quests</button>`;
            else if(opt==='Buy Tools')btns+=`<button class="npc-btn" onclick="npcAction('tools')">Buy Tools</button>`;
            else if(opt==='Bye')btns+=`<button class="npc-btn" onclick="npcAction('close')">Bye!</button>`;
            else btns+=`<button class="npc-btn" onclick="npcAction('close')">${opt}</button>`;
        });
        document.getElementById('npcBtns').innerHTML=btns;
        document.getElementById('npcDialog').style.display='block';
    }

    window.npcAction=function(action){
        if(action==='quests'){npcDialogOpen=false;document.getElementById('npcDialog').style.display='none';questsOpen=true;document.getElementById('questList').classList.add('open');renderQuests();}
        else if(action==='tools'){npcDialogOpen=false;document.getElementById('npcDialog').style.display='none';showToolShop();}
        else{npcDialogOpen=false;document.getElementById('npcDialog').style.display='none';}
    };

    function showToolShop(){
        let txt='Tools Available:\n\n';
        TOOLS.forEach((t,i)=>{
            if(i===0)return;
            if(toolsUnlocked[i])txt+=t.icon+' '+t.name+' - OWNED\n';
            else txt+=t.icon+' '+t.name+' - '+t.cost+' honey (complete quests)\n';
        });
        msg('Tool Shop',txt);
    }

    /* ═══════════════════════════════════════════════════════════════════
       5. POWER-UP SYSTEM
       ═════════════════════════════════════════════════════════════════ */
    const PU_TYPES=[
        {id:'honeyStorm', name:'Honey Storm',  icon:'\uD83C\uDF27\uFE0F', color:[1,.85,.1],   duration:900, desc:'Passive honey gain!'},
        {id:'pollenHaze', name:'Pollen Haze',  icon:'\uD83C\uDF3F',       color:[.4,.9,.3],   duration:1200,desc:'3x pollen collection!'},
        {id:'beeFrenzy',  name:'Bee Frenzy',   icon:'\u26A1',             color:[1,.4,.1],   duration:900, desc:'Bees collect 5x faster!'},
        {id:'magnet',     name:'Pollen Magnet',icon:'\uD83E\uDDF2',       color:[.3,.5,1],   duration:600, desc:'Collect from all nearby flowers!'},
        {id:'starTreat',  name:'Star Treat',   icon:'\u2B50',             color:[1,1,.3],    duration:1,   desc:'Instant honey bonus!'}
    ];

    function spawnPowerup(){
        if(puSpawns.length>=3)return;
        const type=PU_TYPES[Math.floor(Math.random()*PU_TYPES.length)];
        const angle=Math.random()*6.28;
        const dist=10+Math.random()*30;
        puSpawns.push({
            type, x:Math.cos(angle)*dist, z:-30+Math.sin(angle)*dist,
            y:1.5, bobPhase:Math.random()*6.28, age:0
        });
    }

    function checkPowerupPickup(){
        for(let i=puSpawns.length-1;i>=0;i--){
            const pu=puSpawns[i];
            const d=Math.sqrt((pX-pu.x)**2+(pZ-pu.z)**2);
            if(d<2){
                activatePowerup(pu.type);
                puSpawns.splice(i,1);
            }
        }
    }

    function activatePowerup(type){
        if(type.id==='starTreat'){
            const bonus=500+lvl*200;
            honey+=bonus;totHoney+=bonus;
            msg(type.icon+' '+type.name,'Gained '+bonus+' honey instantly!');
            return;
        }
        // Remove existing of same type
        activePowerups=activePowerups.filter(p=>p.id!==type.id);
        activePowerups.push({id:type.id, name:type.name, icon:type.icon, timer:type.duration, max:type.duration});
        msg(type.icon+' '+type.name,type.desc);
    }

    function hasPowerup(id){return activePowerups.some(p=>p.id===id);}

    function renderPowerupBar(){
        const el=document.getElementById('puBar');
        let h='';
        activePowerups.forEach(p=>{
            const secs=Math.ceil(p.timer/60);
            const col=PU_TYPES.find(t=>t.id===p.id);
            const borderCol=col?`rgb(${col.color[0]*255|0},${col.color[1]*255|0},${col.color[2]*255|0})`:'#fff';
            h+=`<div class="pu-active" style="border-color:${borderCol}">${p.icon} <span class="pu-time">${secs}s</span></div>`;
        });
        el.innerHTML=h;
    }

    /* ═══════════════════════════════════════════════════════════════════
       WORLD DATA
       ═════════════════════════════════════════════════════════════════ */
    const FS_=20;
    const flds=[
        {n:'Sunflower',cx:0,cz:-30,c:[1,.85,.1],on:1},
        {n:'Clover',cx:35,cz:-30,c:[.2,.8,.3],on:1},
        {n:'Blue',cx:-35,cz:-30,c:[.3,.5,1],on:0},
        {n:'Rose',cx:0,cz:-65,c:[1,.3,.4],on:0},
        {n:'Mythic',cx:35,cz:-65,c:[.8,.3,1],on:0}
    ];

    const flowers=[];
    function genFlowers(f){for(let i=0;i<40;i++)flowers.push({x:f.cx+(Math.random()-.5)*FS_,z:f.cz+(Math.random()-.5)*FS_,c:f.c,p:5+Math.random()*10|0,mp:5+Math.random()*10|0,fi:flds.indexOf(f),sz:.25+Math.random()*.2});}
    flds.forEach(f=>{if(f.on)genFlowers(f);});

    const bees=[];
    function addBee(){bees.push({x:pX+(Math.random()-.5)*3,y:2+Math.random()*2,z:pZ+(Math.random()-.5)*3,tx:0,ty:2,tz:0,st:'follow',bp:Math.random()*6.28,wp:Math.random()*6.28,spd:.055+Math.random()*.03,tf:null});}
    for(let i=0;i<nBees;i++)addBee();

    const trees=[];
    for(let i=0;i<25;i++){const a=Math.random()*6.28,d=22+Math.random()*40;trees.push({x:Math.cos(a)*d,z:-30+Math.sin(a)*d,h:3+Math.random()*3,tw:.25+Math.random()*.2});}

    const parts=[];
    function addPart(x,y,z,c,life){if(parts.length>100)return;parts.push({x,y,z,c,life,ml:life,vx:(Math.random()-.5)*.04,vy:.02+Math.random()*.03,vz:(Math.random()-.5)*.04});}

    /* ── input ─────────────────────────────────────────────────────── */
    const keys={};
    document.addEventListener('keydown',e=>{
        keys[e.key.toLowerCase()]=true;
        const k=e.key;
        // Tool hotkeys
        if(k>='1'&&k<='5'){const i=parseInt(k)-1;if(toolsUnlocked[i]){activeTool=i;renderToolbar();}}
        // Interact
        if(k==='e'||k==='E'){if(nearNpc&&!npcDialogOpen)openNpcDialog(nearNpc);}
    });
    document.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});

    const md={u:0,d:0,l:0,r:0};
    document.querySelectorAll('.dpad button').forEach(b=>{
        const d=b.dataset.d;
        const on=()=>{md[d]=1;};const off=()=>{md[d]=0;};
        b.addEventListener('touchstart',e=>{e.preventDefault();on();});
        b.addEventListener('touchend',e=>{e.preventDefault();off();});
        b.addEventListener('mousedown',on);b.addEventListener('mouseup',off);b.addEventListener('mouseleave',off);
    });

    document.getElementById('fullscreenBtn').addEventListener('click',()=>{
        if(!document.fullscreenElement)document.documentElement.requestFullscreen().catch(()=>{});
        else document.exitFullscreen();
    });

    /* ── resize ────────────────────────────────────────────────────── */
    function resize(){cv.width=window.innerWidth;cv.height=window.innerHeight;gl.viewport(0,0,cv.width,cv.height);}
    window.addEventListener('resize',resize);resize();

    /* ── shop ──────────────────────────────────────────────────────── */
    function msg(t,b){document.getElementById('popT').textContent=t;document.getElementById('popB').textContent=b;document.getElementById('pop').style.display='block';}

    window.buyBee=function(){if(honey>=beePrc){honey-=beePrc;nBees++;addBee();beePrc=Math.floor(beePrc*1.6);msg('New Bee!','Swarm: '+nBees);save();}};
    window.upgBag=function(){if(honey>=bagPrc){honey-=bagPrc;polMax=Math.floor(polMax*1.5);bagPrc=Math.floor(bagPrc*1.8);msg('Backpack+','Capacity: '+polMax);save();}};
    window.upgSpd=function(){if(honey>=spdPrc){honey-=spdPrc;pSpeed*=1.2;spdPrc=Math.floor(spdPrc*1.7);msg('Speed+','Faster!');save();}};
    window.unlockFld=function(){const lk=flds.find(f=>!f.on);if(lk&&honey>=fldPrc){honey-=fldPrc;lk.on=1;genFlowers(lk);fldPrc=Math.floor(fldPrc*2.5);msg('Field!',lk.n+' unlocked!');save();}};

    function save(){
        localStorage.setItem('bs3dSave2',JSON.stringify({h:honey,b:nBees,pm:polMax,ps:pSpeed,l:lvl,bp:beePrc,bg:bagPrc,sp:spdPrc,fp:fldPrc,th:totHoney,tp:totPollen,tu:toolsUnlocked,qd:questsDone}));
        localStorage.setItem('beeSwarm3dHighScore',totHoney);
    }

    /* ── hud ───────────────────────────────────────────────────────── */
    function updateHUD(){
        document.getElementById('hHoney').textContent=Math.floor(honey);
        document.getElementById('hPollen').textContent=Math.floor(pollen);
        document.getElementById('hPolMax').textContent=polMax;
        document.getElementById('hBees').textContent=nBees;
        document.getElementById('hLvl').textContent=lvl;
        document.getElementById('cBee').textContent=beePrc;
        document.getElementById('cBag').textContent=bagPrc;
        document.getElementById('cSpd').textContent=spdPrc;
        document.getElementById('cFld').textContent=fldPrc;
        document.getElementById('sBee').disabled=honey<beePrc;
        document.getElementById('sBag').disabled=honey<bagPrc;
        document.getElementById('sSpd').disabled=honey<spdPrc;
        document.getElementById('sFld').disabled=honey<fldPrc||!flds.find(f=>!f.on);
    }

    /* ═══════════════════════════════════════════════════════════════════
       GAME LOOP
       ═════════════════════════════════════════════════════════════════ */
    let lt=0;
    function loop(t){
        requestAnimationFrame(loop);
        const dt=Math.min((t-lt)/16.67,3);
        lt=t; frame++;

        // ── Player movement (relative to camera angle)
        let dx=0,dz=0;
        if(keys['w']||keys['arrowup']||md.u)dz-=1;
        if(keys['s']||keys['arrowdown']||md.d)dz+=1;
        if(keys['a']||keys['arrowleft']||md.l)dx-=1;
        if(keys['d']||keys['arrowright']||md.r)dx+=1;
        if(dx||dz){
            const len=Math.sqrt(dx*dx+dz*dz);dx/=len;dz/=len;
            // Rotate movement by camera angle
            const cos=Math.cos(camAngle),sin=Math.sin(camAngle);
            const rx=dx*cos-dz*sin, rz=dx*sin+dz*cos;
            pX+=rx*pSpeed*dt;pZ+=rz*pSpeed*dt;
        }
        pX=Math.max(-55,Math.min(55,pX));
        pZ=Math.max(-85,Math.min(20,pZ));

        const walkBob=(dx||dz)?Math.sin(t*0.01)*0.08:0;
        const isWalking=dx||dz;

        // ── Tool multipliers + power-up multipliers
        let pollenMult=getToolMult('pollenMult');
        let beeSpeedMult=getToolMult('beeSpeed');
        let convertMult=getToolMult('convertRate');
        if(hasPowerup('pollenHaze'))pollenMult*=3;
        if(hasPowerup('beeFrenzy'))beeSpeedMult*=5;

        // ── Hive interaction
        const hd=Math.sqrt(pX*pX+(pZ-5)*(pZ-5));
        if(hd<4.5&&pollen>0){
            const cv_=Math.min(pollen,2*convertMult*dt);
            pollen-=cv_;
            const hg=cv_*(1+lvl*.1)*convertMult;
            honey+=hg;totHoney+=hg;
            if(frame%10===0)addPart(0,4,5,[1,.85,.1],60);
            const nl=lvl*500;
            if(totHoney>=nl){lvl++;msg('Level Up!','Level '+lvl+'!');save();}
        }

        // ── Honey Storm power-up passive income
        if(hasPowerup('honeyStorm')){
            const gain=0.5*dt*(1+lvl*0.2);
            honey+=gain;totHoney+=gain;
            if(frame%15===0)addPart(pX+(Math.random()-.5)*5,6+Math.random()*3,pZ+(Math.random()-.5)*5,[1,.85,.1],40);
        }

        // ── Magnet power-up
        if(hasPowerup('magnet')){
            flowers.forEach(f=>{
                if(f.p<=0||!flds[f.fi].on)return;
                const d=Math.sqrt((f.x-pX)**2+(f.z-pZ)**2);
                if(d<20&&pollen<polMax){
                    const g=Math.min(f.p,.15*dt*pollenMult);
                    f.p-=g;pollen+=g;totPollen+=g;
                    if(frame%20===0)addPart(f.x,1,f.z,f.c,20);
                }
            });
        }

        // ── Bees logic
        bees.forEach(bee=>{
            bee.bp+=.08*dt*beeSpeedMult; bee.wp+=.5*dt;
            if(bee.st==='follow'){
                const ox=Math.sin(bee.bp*.7)*2.5,oz=Math.cos(bee.bp*.5)*2.5;
                bee.tx=pX+ox;bee.ty=2.5+Math.sin(bee.bp)*.5;bee.tz=pZ+oz;
                if(frame%25===0&&pollen<polMax){
                    let closest=null,cd=15;
                    flowers.forEach(f=>{if(f.p<=0||!flds[f.fi].on)return;const d=Math.sqrt((f.x-bee.x)**2+(f.z-bee.z)**2);if(d<cd){cd=d;closest=f;}});
                    if(closest){bee.st='collect';bee.tf=closest;}
                }
            }else if(bee.st==='collect'){
                const f=bee.tf;if(!f||f.p<=0){bee.st='follow';return;}
                bee.tx=f.x;bee.ty=1.2;bee.tz=f.z;
                const d=Math.sqrt((f.x-bee.x)**2+(f.z-bee.z)**2);
                if(d<1){
                    const g=Math.min(f.p,.35*dt*pollenMult*beeSpeedMult);
                    if(pollen+g<=polMax){f.p-=g;pollen+=g;totPollen+=g;if(frame%8===0)addPart(f.x,1,f.z,f.c,30);}
                    if(f.p<=0||pollen>=polMax)bee.st='follow';
                }
            }
            const tdx=bee.tx-bee.x,tdy=bee.ty-bee.y,tdz=bee.tz-bee.z;
            const td=Math.sqrt(tdx*tdx+tdy*tdy+tdz*tdz);
            if(td>.1){const s=bee.spd*dt*beeSpeedMult;bee.x+=tdx/td*s;bee.y+=tdy/td*s;bee.z+=tdz/td*s;}
        });

        // ── Flower regen
        flowers.forEach(f=>{if(f.p<f.mp)f.p=Math.min(f.mp,f.p+.006*dt);});

        // ── Particles
        for(let i=parts.length-1;i>=0;i--){const p=parts[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.z+=p.vz*dt;p.life-=dt;if(p.life<=0)parts.splice(i,1);}

        // ── Power-up timers
        for(let i=activePowerups.length-1;i>=0;i--){
            activePowerups[i].timer-=dt;
            if(activePowerups[i].timer<=0)activePowerups.splice(i,1);
        }

        // ── Power-up spawning
        puSpawnTimer+=dt;
        if(puSpawnTimer>600){puSpawnTimer=0;spawnPowerup();}
        puSpawns.forEach(pu=>{pu.age+=dt;pu.bobPhase+=.05*dt;});
        // Despawn old power-ups
        for(let i=puSpawns.length-1;i>=0;i--){if(puSpawns[i].age>3600)puSpawns.splice(i,1);}
        checkPowerupPickup();

        // ── NPC proximity
        if(frame%10===0)checkNpcProximity();

        // ── Quest check
        if(frame%60===0)checkQuests();

        // Auto-save
        if(frame%300===0)save();

        // ══ RENDER ═══════════════════════════════════════════════════
        gl.clearColor(.47,.76,.96,1);
        gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);
        gl.enable(gl.DEPTH_TEST);gl.enable(gl.CULL_FACE);gl.useProgram(pr);

        // ── Camera (orbiting player)
        const camX=pX+Math.sin(camAngle)*Math.cos(camPitch)*camDist;
        const camY=1+Math.sin(camPitch)*camDist;
        const camZ=pZ+Math.cos(camAngle)*Math.cos(camPitch)*camDist;
        m4.persp(pr_,Math.PI/3.5,cv.width/cv.height,.1,300);
        m4.lookAt(vw,[camX,camY,camZ],[pX,1.5,pZ],[0,1,0]);
        m4.mul(vp,pr_,vw);

        gl.uniform3f(ul.uL,.4,.8,.3);gl.uniform1f(ul.uA,.35);

        // Ground
        draw(gBox,mat([0,-.5,-30],[80,.5,80]),[.25,.6,.2]);

        // Field patches
        flds.forEach(f=>{
            if(f.on)draw(gBox,mat([f.cx,.01,f.cz],[FS_/2,.05,FS_/2]),[f.c[0]*.5,f.c[1]*.5+.2,f.c[2]*.3]);
            else draw(gBox,mat([f.cx,.01,f.cz],[FS_/2,.05,FS_/2]),[.3,.3,.3]);
        });

        // Flowers
        flowers.forEach(f=>{
            if(!flds[f.fi].on)return;const hp=f.p/f.mp;if(hp<.1)return;
            draw(gCyl,mat([f.x,.4,f.z],[.05,.4,.05]),[.2,.5,.15]);
            draw(gSph,mat([f.x,.8+f.sz*.3,f.z],[f.sz*hp,f.sz*hp,f.sz*hp]),f.c);
        });

        // Hive
        draw(gBox,mat([0,1.8,5],[3,1.8,3]),[.85,.6,.15]);
        draw(gCone,mat([0,4.8,5],[3.3,1.4,3.3]),[.7,.45,.1]);
        draw(gBox,mat([0,.8,8],[.5,.6,.25]),[.2,.15,.05]);
        draw(gBox,mat([0,2.5,8.01],[1.2,.8,.05]),[.95,.7,.1]);

        // ── Player character
        draw(gBox,mat([pX,1+walkBob,pZ],[.4,.7,.3]),[.95,.75,.55]);
        draw(gSph,mat([pX,2.15+walkBob,pZ],[.35,.35,.35]),[.95,.78,.58]);
        const legAnim=isWalking?Math.sin(t*0.012)*0.15:0;
        draw(gBox,mat([pX-.2,.3,pZ+legAnim],[.12,.35,.12]),[.3,.3,.8]);
        draw(gBox,mat([pX+.2,.3,pZ-legAnim],[.12,.35,.12]),[.3,.3,.8]);
        const armSwing=isWalking?Math.sin(t*0.012)*0.2:0;
        draw(gBox,mat([pX-.55,1.2+walkBob,pZ+armSwing],[.1,.35,.1]),[.9,.7,.5]);
        draw(gBox,mat([pX+.55,1.2+walkBob,pZ-armSwing],[.1,.35,.1]),[.9,.7,.5]);
        draw(gCyl,mat([pX,2.55+walkBob,pZ],[.45,.15,.45]),[1,1,.8]);
        draw(gCyl,mat([pX,2.45+walkBob,pZ],[.55,.03,.55]),[.95,.95,.75]);
        draw(gSph,mat([pX-.12,2.2+walkBob,pZ+.32],[.06,.06,.06]),[.1,.1,.1]);
        draw(gSph,mat([pX+.12,2.2+walkBob,pZ+.32],[.06,.06,.06]),[.1,.1,.1]);

        // Tool in hand
        if(activeTool>0){
            const toolCol=[[0,0,0],[.5,.5,.5],[.9,.75,.1],[.6,.2,.8],[.9,.8,.2]][activeTool];
            draw(gCyl,mat([pX+.65,1.5+walkBob,pZ+armSwing],[.05,.3,.05]),toolCol);
            draw(gSph,mat([pX+.65,1.85+walkBob,pZ+armSwing],[.1,.1,.1]),toolCol);
        }

        // Backpack
        if(pollen>0){const fill=pollen/polMax;draw(gBox,mat([pX,1+fill*.5+walkBob,pZ-.45],[.3,.2+fill*.35,.2]),[1,.9,.2]);}

        // ── Bees
        bees.forEach(bee=>{
            const by=bee.y+Math.sin(bee.bp)*.15;
            draw(gSph,mat([bee.x,by,bee.z],[.2,.15,.3]),[.95,.8,.1]);
            draw(gSph,mat([bee.x,by,bee.z-.18],[.16,.12,.1]),[.15,.12,.05]);
            draw(gSph,mat([bee.x,by,bee.z+.12],[.18,.13,.06]),[.15,.12,.05]);
            const wf=Math.sin(bee.wp)*.3;
            draw(gSph,mat([bee.x-.22,by+.18+wf*.4,bee.z],[.1,.02,.13]),[.88,.88,1]);
            draw(gSph,mat([bee.x+.22,by+.18-wf*.4,bee.z],[.1,.02,.13]),[.88,.88,1]);
            draw(gCone,mat([bee.x,by-.02,bee.z+.32],[.04,.08,.04]),[.2,.18,.05]);
        });

        // ── NPCs
        NPCS.forEach(npc=>{
            const nx=npc.x,nz=npc.z,nc=npc.color;
            // Body
            draw(gBox,mat([nx,1.2,nz],[.5,.9,.4]),nc);
            // Head
            draw(gSph,mat([nx,2.5,nz],[.42,.42,.42]),nc);
            // Ears
            draw(gSph,mat([nx-.35,2.85,nz],[.15,.15,.15]),nc);
            draw(gSph,mat([nx+.35,2.85,nz],[.15,.15,.15]),nc);
            // Eyes
            draw(gSph,mat([nx-.15,2.55,nz+.38],[.07,.07,.07]),[.05,.05,.05]);
            draw(gSph,mat([nx+.15,2.55,nz+.38],[.07,.07,.07]),[.05,.05,.05]);
            // Nose
            draw(gSph,mat([nx,2.4,nz+.4],[.08,.06,.06]),[.15,.1,.05]);
            // Legs
            draw(gBox,mat([nx-.22,.3,nz],[.14,.35,.14]),nc);
            draw(gBox,mat([nx+.22,.3,nz],[.14,.35,.14]),nc);
            // Name indicator (floating cube)
            const ind=Math.sin(t*.003+npc.x)*.3;
            draw(gSph,mat([nx,3.3+ind,nz],[.12,.12,.12]),[0,.85,1]);
        });

        // ── Power-up spawns (floating glowing orbs)
        puSpawns.forEach(pu=>{
            const py=pu.y+Math.sin(pu.bobPhase)*.5;
            const spin=t*.002;
            const c=pu.type.color;
            // Outer glow
            draw(gSph,mat([pu.x,py,pu.z],[.6+Math.sin(t*.005)*.1,.6+Math.sin(t*.005)*.1,.6+Math.sin(t*.005)*.1]),c);
            // Inner bright core
            draw(gSph,mat([pu.x,py,pu.z],[.3,.3,.3]),[Math.min(1,c[0]+.3),Math.min(1,c[1]+.3),Math.min(1,c[2]+.3)]);
            // Orbiting particle
            draw(gSph,mat([pu.x+Math.cos(spin)*1,py+.5,pu.z+Math.sin(spin)*1],[.08,.08,.08]),c);
            draw(gSph,mat([pu.x-Math.cos(spin)*.8,py-.3,pu.z-Math.sin(spin)*.8],[.06,.06,.06]),c);
        });

        // ── Trees
        trees.forEach(t=>{
            draw(gCyl,mat([t.x,t.h/2,t.z],[t.tw,t.h/2,t.tw]),[.45,.28,.12]);
            draw(gCone,mat([t.x,t.h+1.8,t.z],[2,2.8,2]),[.15,.55,.18]);
            draw(gCone,mat([t.x,t.h+.5,t.z],[2.6,2.2,2.6]),[.18,.5,.15]);
        });

        // ── Clouds
        for(let i=0;i<8;i++){
            const cx=-40+i*12+Math.sin(t*.0002+i)*3;
            const cy=22+Math.sin(i*1.5)*3;
            const cz_=-60+Math.cos(i*2)*15;
            draw(gSph,mat([cx,cy,cz_],[4+Math.sin(i)*1.5,1.5,3+Math.sin(i)*.8]),[1,1,1]);
            draw(gSph,mat([cx+3,cy-.3,cz_],[3,1.2,2.5]),[.98,.98,1]);
        }

        // ── Particles
        parts.forEach(p=>{const a=p.life/p.ml,sz=.06*a;draw(gSph,mat([p.x,p.y,p.z],[sz,sz,sz]),p.c);});

        // ── Fence posts
        flds.forEach(f=>{
            if(!f.on)return;
            for(let i=0;i<8;i++){
                const angle=i/8*Math.PI*2;
                const fx=f.cx+Math.cos(angle)*(FS_/2+1);
                const fz_=f.cz+Math.sin(angle)*(FS_/2+1);
                draw(gCyl,mat([fx,.5,fz_],[.08,.5,.08]),[.55,.35,.15]);
            }
        });

        drawMM();
        updateHUD();
        renderPowerupBar();
    }

    /* ── minimap ───────────────────────────────────────────────────── */
    const mmC=document.getElementById('mm').getContext('2d');
    function drawMM(){
        const w=140,h=140,sc=w/130,ox=w/2,oy=h*.65;
        mmC.fillStyle='#1a2a1a';mmC.fillRect(0,0,w,h);
        flds.forEach(f=>{
            mmC.fillStyle=f.on?`rgb(${f.c[0]*200|0},${f.c[1]*200|0},${f.c[2]*200|0})`:'#333';
            mmC.fillRect(ox+f.cx*sc-FS_/2*sc,oy+f.cz*sc-FS_/2*sc,FS_*sc,FS_*sc);
        });
        // Hive
        mmC.fillStyle='#ffa500';mmC.fillRect(ox-3,oy+5*sc-3,6,6);
        // NPCs
        mmC.fillStyle='#00d9ff';
        NPCS.forEach(n=>{mmC.beginPath();mmC.arc(ox+n.x*sc,oy+n.z*sc,3,0,6.28);mmC.fill();});
        // Power-ups
        mmC.fillStyle='#ff44ff';
        puSpawns.forEach(pu=>{mmC.beginPath();mmC.arc(ox+pu.x*sc,oy+pu.z*sc,2.5,0,6.28);mmC.fill();});
        // Player
        mmC.fillStyle='#00ff88';mmC.beginPath();mmC.arc(ox+pX*sc,oy+pZ*sc,3,0,6.28);mmC.fill();
        // Camera direction indicator
        mmC.strokeStyle='#00ff88';mmC.lineWidth=1;mmC.beginPath();
        mmC.moveTo(ox+pX*sc,oy+pZ*sc);
        mmC.lineTo(ox+pX*sc+Math.sin(camAngle)*8,oy+pZ*sc+Math.cos(camAngle)*8);
        mmC.stroke();
        // Bees
        mmC.fillStyle='#ffcc00';bees.forEach(b=>{mmC.beginPath();mmC.arc(ox+b.x*sc,oy+b.z*sc,1.5,0,6.28);mmC.fill();});
    }

    /* ── init ──────────────────────────────────────────────────────── */
    renderToolbar();
    renderQuests();

    // Spawn initial power-ups
    spawnPowerup();
    spawnPowerup();

    setTimeout(()=>msg('Bee Swarm 3D','WASD to move. Drag mouse to orbit camera, scroll to zoom. Press E near bears to talk. Complete quests to unlock tools! Pick up glowing orbs for power-ups!'),400);
    setTimeout(()=>{const h=document.getElementById('hint');if(h){h.style.opacity='0';setTimeout(()=>h.style.display='none',800);}},15000);

    requestAnimationFrame(loop);
    </script>
</body>
</html>
